我先找出並打開指定的設計文件來閱讀，接著會根據內容設計五大子模組之間與 MGFDKernel 的 JSON 溝通結構。
Ran tool
Ran tool

我已完整閱讀並理解 `MGFD_System_Design_v0.4.3.md`。以下以「簡潔、可擴充、JSON為核心協議」的原則，提出五大子模組彼此之間，以及與核心 `MGFDKernel` 的溝通介面設計。

### 設計原則
- 只用一個統一訊息包封裝，最小必要欄位，避免過度工程化。
- 模組間只交換各自職責必要的資料。
- 使用 name + type + payload 的極簡協定，支援 request/response/event。
- 保留輕量擴充位：meta（可選）。

### 通用訊息包（所有模組通用）
```json
{
  "id": "uuid",
  "session_id": "string",
  "ts": "ISO-8601",
  "src": "ModuleName",
  "dst": "ModuleName|MGFDKernel",
  "type": "request|response|event",
  "name": "ActionName",
  "payload": {},
  "meta": {}
}
```

- 必要欄位：id, session_id, ts, src, dst, type, name, payload
- 可選：meta（輕量註記用）

### 五大子模組 JSON 設計

- UserInputHandler
  - request: 接收原始輸入或請求解析/分類
  - response: 輸入解析結果、意圖、槽位增量
```json
{
  "name": "parse_input",
  "type": "request",
  "payload": {
    "text": "string",
    "lang": "zh-TW"
  }
}
```
```json
{
  "name": "parse_input",
  "type": "response",
  "payload": {
    "intent": "string",
    "confidence": 0.92,
    "slots_delta": { "budget": "30000", "brand": null }
  }
}
```

- PromptManagementHandler
  - request: 取用特定 prompt 或組合 prompt
  - response: 回傳 prompt 字串
```json
{
  "name": "get_prompt",
  "type": "request",
  "payload": {
    "key": "mgfd_principal",
    "combine_with": ["ai_coder_initialization"],
    "separator": "\n\n"
  }
}
```
```json
{
  "name": "get_prompt",
  "type": "response",
  "payload": {
    "prompt": "string"
  }
}
```

- KnowledgeManageHandler
  - request: 規格查詢/語義檢索
  - response: 命中清單（簡化）
```json
{
  "name": "search_specs",
  "type": "request",
  "payload": {
    "query": "高續航 輕薄 14吋",
    "limit": 5
  }
}
```
```json
{
  "name": "search_specs",
  "type": "response",
  "payload": {
    "items": [
      { "model": "ABC-14", "score": 0.83, "reasons": ["battery", "weight"] }
    ]
  }
}
```

- ResponseGenHandler
  - request: 產生可呈現的回應（text/md/cards）
  - response: 回傳渲染物
```json
{
  "name": "render_response",
  "type": "request",
  "payload": {
    "format": "markdown",
    "data": { "greeting": "您好！", "products": [] }
  }
}
```
```json
{
  "name": "render_response",
  "type": "response",
  "payload": {
    "content": "string"
  }
}
```

- StateManageHandler
  - event: 狀態轉移、狀態查詢與更新
```json
{
  "name": "state_transition",
  "type": "event",
  "payload": {
    "from": "On Receive MSG",
    "to": "On Gen New Chat",
    "reason": "user_intent_detected"
  }
}
```
```json
{
  "name": "state_update",
  "type": "request",
  "payload": {
    "key": "slots",
    "delta": { "budget": "30000" }
  }
}
```

### MGFDKernel 與子模組溝通流程（最小協定）
- MGFDKernel 下發需求（request），子模組回傳結果（response），狀態事件由 State 管理（event）。

範例：一次完整對話步驟
1) MGFDKernel → UserInputHandler
```json
{ "name": "parse_input", "type": "request", "payload": { "text": "我想買輕薄續航好的筆電" } }
```
2) UserInputHandler → MGFDKernel
```json
{ "name": "parse_input", "type": "response", "payload": { "intent": "buy_laptop", "slots_delta": { "portability": "high", "battery": "long" } } }
```
3) MGFDKernel → PromptManagementHandler
```json
{ "name": "get_prompt", "type": "request", "payload": { "key": "mgfd_principal" } }
```
4) MGFDKernel → KnowledgeManageHandler
```json
{ "name": "search_specs", "type": "request", "payload": { "query": "輕薄 長續航", "limit": 5 } }
```
5) MGFDKernel → ResponseGenHandler
```json
{ "name": "render_response", "type": "request", "payload": { "format": "markdown", "data": { "products": [] } } }
```
6) StateManageHandler 廣播
```json
{ "name": "state_transition", "type": "event", "payload": { "from": "On LLM Gen Chat From Prompt", "to": "On Send To Front", "reason": "render_ready" } }
```

### 錯誤/例外（統一極簡格式）
- 任一 response 若失敗：
```json
{
  "name": "search_specs",
  "type": "response",
  "payload": {},
  "meta": { "error": { "code": "KB_NOT_AVAILABLE", "message": "knowledge base offline" } }
}
```

### 與 `states_table.csv` 的對齊
- 狀態名直接對應表格，如：
  - OnReceiveMSG → 解析輸入（UserInputHandler）
  - OnGenNewChat → 系統新回合準備（StateManageHandler）
  - OnLLMGenChatFromPrompt → 取 prompt 與推論（Prompt/LLM）
  - OnGenMDContents → 渲染輸出（ResponseGenHandler）
  - OnSendToFront → 前端輸出（ResponseGenHandler）
  - OnWaitUserResponse → 等待輸入（UserInputHandler）

### 總結
- 用單一輕量通用封包，name+type+payload 描述一次動作。
- 五模組各自只傳遞職責必要資料。
- 與 MGFDKernel 的互動是「Kernel 發 request、子模組回 response、State 廣播 event」。
- 保持極簡，保留 meta 供後續擴展，不主動增加複雜欄位。