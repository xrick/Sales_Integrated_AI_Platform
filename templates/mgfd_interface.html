<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MGFD Á≠ÜË®òÂûãÈõªËÖ¶Ë≥ºÁâ©Âä©Êâã</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 800px;
            height: 80vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .chat-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message.assistant {
            justify-content: flex-start;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
        }

        .message.user .message-content {
            background: #667eea;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.assistant .message-content {
            background: white;
            color: #333;
            border: 1px solid #e1e5e9;
            border-bottom-left-radius: 4px;
        }

        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin: 0 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        .avatar.user {
            background: #667eea;
            color: white;
        }

        .avatar.assistant {
            background: #28a745;
            color: white;
        }

        .input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e1e5e9;
        }

        .input-group {
            display: flex;
            gap: 10px;
        }

        .message-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        .message-input:focus {
            border-color: #667eea;
        }

        .send-button {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.3s;
        }

        .send-button:hover {
            background: #5a6fd8;
        }

        .send-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .session-info {
            background: #e3f2fd;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 12px;
            color: #1976d2;
        }

        .recommendations {
            background: #f0f8ff;
            border: 1px solid #b3d9ff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }

        .recommendation-item {
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
        }

        .recommendation-item:last-child {
            margin-bottom: 0;
        }

        .product-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .product-details {
            font-size: 12px;
            color: #666;
            line-height: 1.4;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .stats {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 12px;
            color: #666;
        }

        /* Funnel Question Ê®£Âºè */
        .funnel-container {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin: 10px 0;
        }

        .funnel-container h3 {
            color: #495057;
            margin-bottom: 15px;
            text-align: center;
        }

        .funnel-question {
            font-size: 16px;
            font-weight: 500;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }

        .funnel-message {
            color: #6c757d;
            font-size: 14px;
            text-align: center;
            margin-bottom: 20px;
        }

        .funnel-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .funnel-option-btn {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .funnel-option-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.1);
        }

        .funnel-option-btn:active {
            transform: translateY(0);
        }

        .option-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .option-icon {
            font-size: 18px;
            margin-right: 10px;
        }

        .option-title {
            font-weight: 600;
            color: #333;
            font-size: 16px;
        }

        .option-description {
            color: #6c757d;
            font-size: 14px;
            line-height: 1.4;
        }

        /* Elicitation Ê®£Âºè */
        .elicitation-container {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .suggestions {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .suggestion-chip {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            cursor: pointer;
        }

        .suggestion-chip:hover {
            background: #5a6fd8;
        }

        /* Clarification Ê®£Âºè */
        .clarification {
            background: #e3f2fd;
            border: 1px solid #b3d9ff;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        /* Funnel Complete Ê®£Âºè */
        .funnel-complete {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 20px;
            margin: 10px 0;
        }

        .funnel-complete h3 {
            color: #155724;
            text-align: center;
            margin-bottom: 15px;
        }

        .complete-message {
            text-align: center;
            color: #155724;
            font-weight: 500;
            margin-bottom: 20px;
        }

        .flow-info {
            background: white;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .flow-info h4 {
            color: #333;
            margin-bottom: 10px;
        }

        .flow-info p {
            margin-bottom: 8px;
            color: #666;
        }

        .loading-indicator {
            text-align: center;
            color: #6c757d;
        }

        .loading-indicator p {
            margin-top: 10px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ MGFD Á≠ÜË®òÂûãÈõªËÖ¶Ë≥ºÁâ©Âä©Êâã</h1>
            <p>Multi-Guided Funnel Dialogue Êô∫ËÉΩÂ∞çË©±Á≥ªÁµ±</p>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="session-info" id="sessionInfo">
                Ê≠£Âú®ÂàùÂßãÂåñÊúÉË©±...
            </div>
            <div class="stats" id="stats">
                Á≥ªÁµ±ÁãÄÊÖã: ÂàùÂßãÂåñ‰∏≠...
            </div>
        </div>

        <div class="input-container">
            <div class="input-group">
                <input 
                    type="text" 
                    id="messageInput" 
                    class="message-input" 
                    placeholder="Ë´ãÂëäË®¥ÊàëÊÇ®ÊÉ≥Ë¶Å‰ªÄÈ∫ºÊ®£ÁöÑÁ≠ÜÈõª..."
                    disabled
                >
                <button id="sendButton" class="send-button" disabled>
                    ÁôºÈÄÅ
                </button>
            </div>
        </div>
    </div>

    <script>
        class MGFDChat {
            constructor() {
                this.sessionId = null;
                this.isLoading = false;
                this.renderedQuestions = new Set(); // ËøΩËπ§Â∑≤Ê∏≤ÊüìÁöÑÂïèÈ°å
                this.questionHistory = new Map(); // ÂïèÈ°åÊ≠∑Âè≤Ë®òÈåÑ
                this.init();
            }

            async init() {
                try {
                    await this.createSession();
                    await this.loadStats();
                    this.setupEventListeners();
                    this.enableInput();
                } catch (error) {
                    console.error('ÂàùÂßãÂåñÂ§±Êïó:', error);
                    this.showError('Á≥ªÁµ±ÂàùÂßãÂåñÂ§±ÊïóÔºåË´ãÂà∑Êñ∞È†ÅÈù¢ÈáçË©¶');
                }
            }

            async createSession() {
                const response = await fetch('/api/mgfd_cursor/session/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });

                if (!response.ok) {
                    throw new Error('ÂâµÂª∫ÊúÉË©±Â§±Êïó');
                }

                const data = await response.json();
                this.sessionId = data.session_id;
                
                // üîÑ Ê∏ÖÁêÜÂïèÈ°åÊ≠∑Âè≤ÔºàÊñ∞ÊúÉË©±ÊôÇÔºâ
                this.questionHistory.clear();
                this.renderedQuestions.clear();
                console.log('üÜï New session created, question history cleared');
                
                this.addMessage('assistant', data.message);
                this.updateSessionInfo();
            }

            async loadStats() {
                try {
                    const response = await fetch('/api/mgfd_cursor/stats');
                    if (response.ok) {
                        const data = await response.json();
                        this.updateStats(data.system_stats);
                    }
                } catch (error) {
                    console.error('ËºâÂÖ•Áµ±Ë®à‰ø°ÊÅØÂ§±Êïó:', error);
                }
            }

            setupEventListeners() {
                const messageInput = document.getElementById('messageInput');
                const sendButton = document.getElementById('sendButton');

                messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !this.isLoading) {
                        this.sendMessage();
                    }
                });

                sendButton.addEventListener('click', () => {
                    if (!this.isLoading) {
                        this.sendMessage();
                    }
                });
            }

            enableInput() {
                document.getElementById('messageInput').disabled = false;
                document.getElementById('sendButton').disabled = false;
            }

            async sendMessage() {
                const messageInput = document.getElementById('messageInput');
                const message = messageInput.value.trim();

                if (!message || this.isLoading) return;

                this.isLoading = true;
                this.setLoadingState(true);

                // Ê∑ªÂä†Áî®Êà∂Ê∂àÊÅØ
                this.addMessage('user', message);
                messageInput.value = '';

                try {
                    const response = await fetch('/api/mgfd_cursor/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: message,
                            session_id: this.sessionId
                        })
                    });

                    if (!response.ok) {
                        throw new Error('ÁôºÈÄÅÊ∂àÊÅØÂ§±Êïó');
                    }

                    const data = await response.json();
                    
                    console.log('üîÑ Received data from backend:', data);
                    
                    // Êô∫ËÉΩËôïÁêÜÂÖ©Á®ÆÂõûÊáâÊ†ºÂºè
                    let content, fullData;
                    
                    if (data.type && (data.type === 'funnel_question' || data.type === 'funnel_complete' || data.type === 'elicitation' || data.type === 'recommendation' || data.type === 'clarification' || data.type === 'error')) {
                        // Áõ¥Êé•ÁöÑÁµêÊßãÂåñÂõûÊáâÊ†ºÂºè
                        content = data;  // Â∞áÊï¥ÂÄãÁâ©‰ª∂‰ΩúÁÇ∫ÂÖßÂÆπ
                        fullData = data;
                        console.log('üìã Detected structured response format:', data.type);
                    } else if (data.response !== undefined) {
                        // Ê®ôÊ∫ñÁöÑÂåÖË£ùÊ†ºÂºè {response: content, ...}
                        content = data.response;
                        fullData = data;
                        console.log('üì¶ Detected standard response format');
                    } else if (data.success === false && data.error) {
                        // ÈåØË™§ÂõûÊáâÊ†ºÂºè
                        content = data.error;
                        fullData = data;
                        console.log('‚ùå Detected error response format');
                    } else {
                        // ÈôçÁ¥öËôïÁêÜÔºöÂ∞áÊï¥ÂÄãÂõûÊáâ‰ΩúÁÇ∫ÂÖßÂÆπËôïÁêÜ
                        content = data;
                        fullData = data;
                        console.log('üîß Fallback: treating entire data as structured content');
                    }
                    
                    // Ê∑ªÂä†Âä©ÊâãÂõûÊáâ
                    this.addMessage('assistant', content, fullData);

                    // Êõ¥Êñ∞ÊúÉË©±‰ø°ÊÅØ
                    this.updateSessionInfo(fullData);

                } catch (error) {
                    console.error('ÁôºÈÄÅÊ∂àÊÅØÂ§±Êïó:', error);
                    this.showError('ÁôºÈÄÅÊ∂àÊÅØÂ§±ÊïóÔºåË´ãÈáçË©¶');
                } finally {
                    this.isLoading = false;
                    this.setLoadingState(false);
                }
            }

            addMessage(role, content, data = null) {
                const chatContainer = document.getElementById('chatContainer');
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${role}`;

                const avatar = document.createElement('div');
                avatar.className = `avatar ${role}`;
                avatar.textContent = role === 'user' ? 'U' : 'A';

                const messageContent = document.createElement('div');
                messageContent.className = 'message-content';

                if (role === 'assistant') {
                    // ËôïÁêÜÂä©ÊâãÂõûÊáâ - ÊîØÊè¥ÁµêÊßãÂåñJSONÂõûÊáâ
                    this.renderAssistantMessage(messageContent, content, data);
                } else {
                    // Áî®Êà∂Ê∂àÊÅØ‰øùÊåÅÁ∞°ÂñÆÊñáÂ≠óÈ°ØÁ§∫
                    messageContent.textContent = content;
                }

                messageDiv.appendChild(avatar);
                messageDiv.appendChild(messageContent);
                chatContainer.appendChild(messageDiv);

                // ÊªæÂãïÂà∞Â∫ïÈÉ®
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            renderAssistantMessage(container, content, data = null) {
                console.log('üîß renderAssistantMessage called with:', { 
                    contentType: typeof content, 
                    contentValue: content, 
                    dataType: typeof data,
                    dataKeys: data ? Object.keys(data) : null
                });
                
                // ËôïÁêÜ null Êàñ undefined ÁöÑÂÖßÂÆπ
                if (content === null || content === undefined) {
                    console.error('‚ùå Content is null or undefined, using fallback');
                    if (data && typeof data === 'object') {
                        content = data;  // ‰ΩøÁî®Êï¥ÂÄã data Â∞çË±°‰ΩúÁÇ∫ÂÖßÂÆπ
                        console.log('üîÑ Using data object as content:', data);
                    } else {
                        container.innerHTML = '<p style="color: orange;">‚ö†Ô∏è Êî∂Âà∞Á©∫ÁôΩÂõûÊáâ</p>';
                        return;
                    }
                }
                
                // Â¶ÇÊûúcontentÊòØÂ≠óÁ¨¶‰∏≤‰ΩÜÁúãËµ∑‰æÜÂÉèJSONÔºåÂòóË©¶Ëß£Êûê
                let parsedContent = content;
                if (typeof content === 'string') {
                    try {
                        // Ê™¢Êü•ÊòØÂê¶ÊòØJSONÂ≠óÁ¨¶‰∏≤
                        if (content.trim().startsWith('{') && content.trim().endsWith('}')) {
                            parsedContent = JSON.parse(content);
                            console.log('üìù Parsed JSON content:', parsedContent);
                        }
                    } catch (e) {
                        console.log('üìù Content is not JSON, treating as plain text:', e.message);
                    }
                }
                
                // Â¶ÇÊûúÊòØÁµêÊßãÂåñÊï∏ÊìöÔºåËôïÁêÜÁâπÊÆäÈ°ûÂûã
                if (typeof parsedContent === 'object' && parsedContent !== null) {
                    console.log('üéØ Processing structured content:', parsedContent);
                    this.renderStructuredResponse(container, parsedContent);
                } else if (data && data.recommendations) {
                    // ÂÖºÂÆπËàäÊ†ºÂºèÔºöÂ¶ÇÊûúÊúâÊé®Ëñ¶Áî¢ÂìÅÔºåÊ†ºÂºèÂåñÈ°ØÁ§∫
                    console.log('üìã Processing legacy recommendation format');
                    container.innerHTML = this.formatRecommendations(content, data.recommendations);
                } else {
                    // ÊôÆÈÄöÊñáÂ≠óÂõûÊáâ
                    console.log('üìÑ Processing plain text response');
                    container.textContent = content || '(Á©∫ÁôΩÂõûÊáâ)';
                }
            }

            renderStructuredResponse(container, response) {
                console.log('üéØ renderStructuredResponse called with:', response);
                
                const responseType = response.type || 'text';
                
                switch (responseType) {
                    case 'funnel_question':
                        this.renderFunnelQuestion(container, response);
                        break;
                    case 'funnel_complete':
                        this.renderFunnelComplete(container, response);
                        break;
                    case 'elicitation':
                        this.renderElicitation(container, response);
                        break;
                    case 'recommendation':
                        this.renderRecommendation(container, response);
                        break;
                    case 'clarification':
                        this.renderClarification(container, response);
                        break;
                    case 'error':
                        this.renderError(container, response);
                        break;
                    default:
                        // ËôïÁêÜÊú™Áü•È°ûÂûãÊàñ‰∏ÄËà¨ÂõûÊáâ
                        this.renderGeneralResponse(container, response);
                }
            }

            renderFunnelQuestion(container, response) {
                console.log('üî• Rendering funnel question:', response);
                
                // Â¢ûÂº∑ÁöÑÊ†ºÂºèÈ©óË≠âÂíåÈåØË™§ËôïÁêÜ
                if (!response) {
                    console.error('‚ùå Response is null or undefined');
                    container.innerHTML = '<p style="color: red;">ÂõûÊáâÊï∏ÊìöÁÇ∫Á©∫</p>';
                    return;
                }
                
                const { question, session_id, message } = response;
                
                // Ë©≥Á¥∞ÁöÑÂ≠óÊÆµÈ©óË≠â
                if (!question) {
                    console.error('‚ùå Missing question field in response:', response);
                    container.innerHTML = '<p style="color: red;">Áº∫Â∞ëÂïèÈ°åÊï∏Êìö</p>';
                    return;
                }
                
                if (!question.question_text) {
                    console.error('‚ùå Missing question_text in question:', question);
                    container.innerHTML = '<p style="color: red;">Áº∫Â∞ëÂïèÈ°åÊñáÂ≠ó</p>';
                    return;
                }
                
                if (!question.options || !Array.isArray(question.options) || question.options.length === 0) {
                    console.error('‚ùå Invalid options in question:', question.options);
                    container.innerHTML = '<p style="color: red;">Áº∫Â∞ëÊúâÊïàÁöÑÈÅ∏È†Ö</p>';
                    return;
                }
                
                // È©óË≠âÈÅ∏È†ÖÊ†ºÂºè
                for (let i = 0; i < question.options.length; i++) {
                    const option = question.options[i];
                    if (!option.option_id || !option.label || !option.description) {
                        console.error(`‚ùå Invalid option at index ${i}:`, option);
                        container.innerHTML = `<p style="color: red;">ÈÅ∏È†Ö ${i + 1} Ê†ºÂºèÈåØË™§</p>`;
                        return;
                    }
                }
                
                // üîÑ Êñ∞Â¢ûÔºöÂéªÈáçÈÇèËºØÊ™¢Êü•  
                const questionKey = this.generateQuestionKey(question, session_id);
                const currentTime = Date.now();
                
                // Ê™¢Êü•ÊòØÂê¶ÊòØÈáçË§áÁöÑÂïèÈ°åÔºà5ÂàÜÈêòÂÖßÁöÑÁõ∏ÂêåÂïèÈ°åË¶ñÁÇ∫ÈáçË§áÔºâ
                if (this.questionHistory.has(questionKey)) {
                    const lastTime = this.questionHistory.get(questionKey);
                    const timeDiff = currentTime - lastTime;
                    const DUPLICATE_THRESHOLD = 5 * 60 * 1000; // 5ÂàÜÈêò
                    
                    if (timeDiff < DUPLICATE_THRESHOLD) {
                        console.warn('üö´ Duplicate funnel question detected, skipping render:', {
                            questionKey,
                            timeDiff: `${Math.round(timeDiff/1000)}s`,
                            threshold: `${DUPLICATE_THRESHOLD/1000}s`
                        });
                        
                        container.innerHTML = `
                            <div class="funnel-container" style="opacity: 0.7; border: 2px dashed #ffc107;">
                                <h3>‚ö†Ô∏è ÈáçË§áÂïèÈ°åÂÅµÊ∏¨</h3>
                                <p class="funnel-message">Ê≠§ÂïèÈ°åÂú® ${Math.round(timeDiff/1000)} ÁßíÂâçÂ∑≤È°ØÁ§∫ÈÅéÔºåÂ∑≤Ëá™ÂãïÁï•ÈÅéÈáçË§áÊ∏≤Êüì„ÄÇ</p>
                                <p style="font-size: 12px; color: #6c757d;">Â¶ÇÊûúÈÄôÊòØÈåØË™§ÔºåË´ãÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢ÊàñËÅØÁµ°ÊäÄË°ìÊîØÊè¥„ÄÇ</p>
                            </div>
                        `;
                        return;
                    }
                }
                
                // Ë®òÈåÑÊ≠§ÂïèÈ°åÁöÑÈ°ØÁ§∫ÊôÇÈñì
                this.questionHistory.set(questionKey, currentTime);
                
                console.log('‚úÖ Funnel question validation passed');
                
                let html = `
                    <div class="funnel-container" data-question-key="${questionKey}">
                        <h3>üéØ ÈúÄÊ±ÇÈ°ûÂûãÈÅ∏Êìá</h3>
                        <p class="funnel-question">${question.question_text}</p>
                        ${message ? `<p class="funnel-message">${message}</p>` : ''}
                        
                        <div class="funnel-options">
                `;
                
                question.options.forEach((option, index) => {
                    html += `
                        <button class="funnel-option-btn" 
                                data-option-id="${option.option_id}" 
                                data-session-id="${session_id}"
                                onclick="mgfdChat.handleFunnelOptionClick('${option.option_id}', '${session_id}')">
                            <div class="option-header">
                                <span class="option-icon">${option.label.split(' ')[0] || 'üìã'}</span>
                                <span class="option-title">${option.label.split(' ').slice(1).join(' ') || option.label}</span>
                            </div>
                            <div class="option-description">${option.description}</div>
                        </button>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
                
                container.innerHTML = html;
            }
            
            // üÜï Êñ∞Â¢ûÔºöÁîüÊàêÂïèÈ°åÂîØ‰∏ÄÈçµÁöÑÊñπÊ≥ï
            generateQuestionKey(question, sessionId = '') {
                // Âü∫ÊñºÂïèÈ°åÊñáÂ≠ó„ÄÅÈÅ∏È†ÖÂíåÊúÉË©±IDÁîüÊàêÂîØ‰∏ÄÈçµ
                const questionText = question.question_text || '';
                const optionsText = question.options ? 
                    question.options.map(opt => `${opt.option_id}-${opt.label}`).join('|') : '';
                
                // ÂåÖÂê´session_idÈÅøÂÖç‰∏çÂêåÊúÉË©±ÈñìÁöÑÈáçË§áÂïèÈ°åË™§Âà§
                const key = `${sessionId}::${questionText}::${optionsText}`;
                
                // ‰ΩøÁî®Á∞°ÂñÆÁöÑÈõúÊπäÂáΩÊï∏ÁîüÊàêËºÉÁü≠ÁöÑÈçµ
                let hash = 0;
                for (let i = 0; i < key.length; i++) {
                    const char = key.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // ËΩâÊèõÁÇ∫32‰ΩçÊï¥Êï∏
                }
                
                return `fq_${Math.abs(hash).toString(16)}`;
            }

            renderElicitation(container, response) {
                const content = response.content || 'Ë´ãÊèê‰æõÊõ¥Â§öË≥áË®ä‰ª•Âπ´Âä©ÊÇ®ÊâæÂà∞ÂêàÈÅ©ÁöÑÁî¢ÂìÅ„ÄÇ';
                const suggestions = response.suggestions || [];
                
                let html = `
                    <div class="elicitation-container">
                        <p>${content}</p>
                `;
                
                if (suggestions.length > 0) {
                    html += '<div class="suggestions">';
                    suggestions.forEach(suggestion => {
                        html += `<span class="suggestion-chip">${suggestion}</span>`;
                    });
                    html += '</div>';
                }
                
                html += '</div>';
                container.innerHTML = html;
            }

            renderRecommendation(container, response) {
                const content = response.content || '';
                const recommendations = response.recommendations || [];
                
                container.innerHTML = this.formatRecommendations(content, recommendations);
            }

            renderFunnelComplete(container, response) {
                console.log('‚úÖ Rendering funnel complete:', response);
                
                const { target_flow, original_query, user_choice, message } = response;
                
                let html = `
                    <div class="funnel-complete">
                        <h3>‚úÖ ÈúÄÊ±ÇÂàÜÊûêÂÆåÊàê</h3>
                        <p class="complete-message">${message || 'Â∑≤ÁÇ∫ÊÇ®ÂàÜÊûêÂÆåÊàêÔºåÊ≠£Âú®Ê∫ñÂÇôÁµêÊûú...'}</p>
                        
                        <div class="flow-info">
                            <h4>üìã ÂàÜÊûêÁµêÊûú</h4>
                            <p><strong>ÂéüÂßãÊü•Ë©¢Ôºö</strong>${original_query || 'Êú™Áü•'}</p>
                            <p><strong>ÈÅ∏ÊìáÊµÅÁ®ãÔºö</strong>${target_flow || 'Êú™Áü•'}</p>
                            ${user_choice ? `<p><strong>ÈÅ∏ÊìáÈÅ∏È†ÖÔºö</strong>${user_choice.label || user_choice}</p>` : ''}
                        </div>
                        
                        <div class="loading-indicator">
                            <div class="loading"></div>
                            <p>Ê≠£Âú®Âü∑Ë°åÂ∞àÊ•≠ÂàÜÊûê...</p>
                        </div>
                    </div>
                `;
                
                container.innerHTML = html;
                
                // Â¶ÇÊûúÊúâÈÄ≤‰∏ÄÊ≠•ÁöÑËôïÁêÜÁµêÊûúÔºåÂèØ‰ª•Âú®ÈÄôË£°Ê∑ªÂä†
                if (response.recommendations) {
                    // Áõ¥Êé•È°ØÁ§∫Êé®Ëñ¶ÁµêÊûú
                    setTimeout(() => {
                        this.renderRecommendation(container, response);
                    }, 1500);
                }
            }

            renderClarification(container, response) {
                const content = response.content || 'ÈúÄË¶ÅÊÇ®ÊæÑÊ∏Ö‰∏Ä‰∫õÁ¥∞ÁØÄ„ÄÇ';
                container.innerHTML = `<div class="clarification">${content}</div>`;
            }

            renderError(container, response) {
                const error = response.error || response.content || 'ÁôºÁîüÊú™Áü•ÈåØË™§';
                container.innerHTML = `<div class="error">‚ùå ${error}</div>`;
            }

            renderGeneralResponse(container, response) {
                console.log('üîß renderGeneralResponse called with:', response);
                
                // ËôïÁêÜ‰∏ÄËà¨ÁµêÊßãÂåñÂõûÊáâ
                if (response.content) {
                    console.log('üìÑ Using response.content');
                    container.innerHTML = response.content;
                } else if (response.message) {
                    console.log('üìÑ Using response.message');
                    container.innerHTML = response.message;
                } else if (typeof response === 'string') {
                    console.log('üìÑ Response is string, displaying directly');
                    container.textContent = response;
                } else {
                    // Â¶ÇÊûúÊ≤íÊúâÊòéÁ¢∫ÁöÑÂÖßÂÆπÂ≠óÊÆµÔºåÂòóË©¶Êèê‰æõÊõ¥ÂèãÂñÑÁöÑÈ°ØÁ§∫
                    console.log('‚ùì Unknown response format, using fallback display');
                    
                    let displayContent = '';
                    
                    // Ê™¢Êü•ÊòØÂê¶ÊúâÂ∏∏Ë¶ãÁöÑÂ≠óÊÆµ
                    if (response.type) {
                        displayContent += `<p><strong>È°ûÂûã:</strong> ${response.type}</p>`;
                    }
                    
                    if (response.error) {
                        displayContent += `<p style="color: red;"><strong>ÈåØË™§:</strong> ${response.error}</p>`;
                    }
                    
                    if (response.session_id) {
                        displayContent += `<p><strong>ÊúÉË©±ID:</strong> ${response.session_id}</p>`;
                    }
                    
                    // Â¶ÇÊûúÊ≤íÊúâ‰ªª‰ΩïÊúâÁî®ÁöÑÂ≠óÊÆµÔºåÈ°ØÁ§∫JSONÔºà‰ΩÜÊõ¥ÁæéËßÄÔºâ
                    if (!displayContent) {
                        displayContent = `
                            <div style="background: #f5f5f5; padding: 10px; border-radius: 8px; margin: 10px 0;">
                                <p><strong>‚ö†Ô∏è Êú™Áü•ÂõûÊáâÊ†ºÂºè</strong></p>
                                <details>
                                    <summary>ÈªûÊìäÊü•ÁúãÂéüÂßãÊï∏Êìö (Ë™øË©¶Áî®)</summary>
                                    <pre style="font-size: 12px; overflow-x: auto;">${JSON.stringify(response, null, 2)}</pre>
                                </details>
                            </div>
                        `;
                    }
                    
                    container.innerHTML = displayContent;
                }
            }

            async handleFunnelOptionClick(optionId, sessionId) {
                console.log('üéØ Funnel option clicked:', { optionId, sessionId });
                
                // üîÑ Á¶ÅÁî®ÊâÄÊúâÈÅ∏È†ÖÊåâÈàïÈò≤Ê≠¢ÈáçË§áÈªûÊìä
                const optionButtons = document.querySelectorAll('.funnel-option-btn');
                optionButtons.forEach(btn => {
                    btn.disabled = true;
                    btn.style.opacity = '0.6';
                    btn.style.cursor = 'not-allowed';
                });
                
                // Ê®ôÁ§∫Â∑≤ÈÅ∏ÊìáÁöÑÈÅ∏È†Ö
                const selectedButton = document.querySelector(`[data-option-id="${optionId}"]`);
                if (selectedButton) {
                    selectedButton.style.backgroundColor = '#667eea';
                    selectedButton.style.color = 'white';
                    selectedButton.style.border = '2px solid #667eea';
                }
                
                try {
                    // ÁôºÈÄÅÈÅ∏ÊìáÂà∞ÂæåÁ´Ø
                    const response = await fetch('/api/mgfd_cursor/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: `ÈÅ∏ÊìáÈÅ∏È†Ö: ${optionId}`,
                            session_id: sessionId
                        })
                    });

                    if (!response.ok) {
                        throw new Error('ËôïÁêÜÈÅ∏ÊìáÂ§±Êïó');
                    }

                    const data = await response.json();
                    
                    // üó∫Ô∏è Ê∏ÖÁêÜÁõ∏ÈóúÁöÑÂïèÈ°åÊ≠∑Âè≤ÔºàÈÅøÂÖçÈáçË§áÂïèÈ°åÔºâ
                    this.clearRelatedQuestionHistory(optionId, sessionId);
                    
                    // Ê∑ªÂä†Êñ∞ÁöÑÂõûÊáâ
                    this.addMessage('assistant', data.response, data);
                    this.updateSessionInfo(data);

                } catch (error) {
                    console.error('ËôïÁêÜfunnelÈÅ∏ÊìáÂ§±Êïó:', error);
                    this.showError('ËôïÁêÜÈÅ∏ÊìáÂ§±ÊïóÔºåË´ãÈáçË©¶');
                    
                    // üîÑ ÁôºÁîüÈåØË™§ÊôÇÈáçÊñ∞ÂïüÁî®ÈÅ∏È†ÖÊåâÈàï
                    const optionButtons = document.querySelectorAll('.funnel-option-btn');
                    optionButtons.forEach(btn => {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                        btn.style.cursor = 'pointer';
                    });
                }
            }
            
            // üó∫Ô∏è Êñ∞Â¢ûÔºöÊ∏ÖÁêÜÁõ∏ÈóúÂïèÈ°åÊ≠∑Âè≤ÁöÑÊñπÊ≥ï
            clearRelatedQuestionHistory(selectedOptionId, currentSessionId = '') {
                console.log('üßπ Clearing related question history for option:', selectedOptionId, 'session:', currentSessionId);
                
                // Ê∏ÖÁêÜÁ≠ñÁï•Ôºö
                // 1. Ê∏ÖÁêÜË∂ÖÈÅé10ÂàÜÈêòÁöÑËàäÂïèÈ°åÊ≠∑Âè≤
                // 2. Ê∏ÖÁêÜÁï∂ÂâçÊúÉË©±‰∏≠ÂèØËÉΩÂ∞éËá¥Âæ™Áí∞ÁöÑÁõ∏ÈóúÂïèÈ°å
                const keysToDelete = [];
                const currentTime = Date.now();
                const MAX_AGE = 10 * 60 * 1000; // 10ÂàÜÈêò
                
                for (const [key, timestamp] of this.questionHistory.entries()) {
                    // Ê∏ÖÁêÜË∂ÖÈÅé10ÂàÜÈêòÁöÑËàäÂïèÈ°åÊ≠∑Âè≤
                    const age = currentTime - timestamp;
                    if (age > MAX_AGE) {
                        keysToDelete.push(key);
                        console.log('üïí Marking old question for deletion:', key, `(${Math.round(age/1000)}s old)`);
                        continue;
                    }
                    
                    // Ê∏ÖÁêÜÁï∂ÂâçÊúÉË©±‰∏≠5ÂàÜÈêòÂÖßÁöÑÁõ∏ÈóúÂïèÈ°åÔºàÈò≤Ê≠¢Á´ãÂç≥ÈáçË§áÔºâ
                    if (currentSessionId && age < 5 * 60 * 1000) {
                        // Â¶ÇÊûúÂïèÈ°åÂåÖÂê´Áï∂ÂâçÊúÉË©±ID‰∏îÊôÇÈñìËºÉËøëÔºåËÄÉÊÖÆÊ∏ÖÁêÜ
                        const sessionPrefix = `fq_`;
                        if (key.startsWith(sessionPrefix)) {
                            // ÈÄôÊòØ‰∏ÄÂÄãfunnel questionÔºåÂ¶ÇÊûúÁî®Êà∂Â∑≤Á∂ìÈÅ∏Êìá‰∫ÜÈÅ∏È†ÖÔºåÊ∏ÖÁêÜÁõ∏ÈóúÁöÑÂïèÈ°å
                            keysToDelete.push(key);
                            console.log('üîÑ Marking recent related question for deletion:', key, `(${Math.round(age/1000)}s ago)`);
                        }
                    }
                }
                
                // Âà™Èô§Ê®ôË®òÁöÑÂïèÈ°åÊ≠∑Âè≤
                keysToDelete.forEach(key => {
                    this.questionHistory.delete(key);
                    console.log('üóëÔ∏è Cleaned question:', key);
                });
                
                console.log('‚úÖ Question history cleanup complete:', {
                    remainingEntries: this.questionHistory.size,
                    deletedEntries: keysToDelete.length,
                    selectedOption: selectedOptionId,
                    sessionId: currentSessionId
                });
            }

            formatRecommendations(content, recommendations) {
                let html = `<div>${content}</div>`;
                
                if (recommendations && recommendations.length > 0) {
                    html += '<div class="recommendations">';
                    recommendations.forEach(product => {
                        html += `
                            <div class="recommendation-item">
                                <div class="product-name">${product.name}</div>
                                <div class="product-details">
                                    ÂìÅÁâå: ${product.brand.toUpperCase()}<br>
                                    ËôïÁêÜÂô®: ${product.cpu}<br>
                                    È°ØÁ§∫Âç°: ${product.gpu}<br>
                                    Ë®òÊÜ∂È´î: ${product.ram}<br>
                                    ÈáçÈáè: ${product.weight}<br>
                                    ÊèèËø∞: ${product.description}
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                }

                return html;
            }

            updateSessionInfo(data = null) {
                const sessionInfo = document.getElementById('sessionInfo');
                if (data) {
                    sessionInfo.innerHTML = `
                        ÊúÉË©±ID: ${this.sessionId}<br>
                        Áï∂ÂâçÈöéÊÆµ: ${data.current_stage}<br>
                        Â∑≤Â°´ÂØ´ÊßΩ‰Ωç: ${Object.keys(data.filled_slots).length}
                    `;
                } else {
                    sessionInfo.innerHTML = `ÊúÉË©±ID: ${this.sessionId}`;
                }
            }

            updateStats(stats) {
                const statsDiv = document.getElementById('stats');
                statsDiv.innerHTML = `
                    Ê¥ªË∫çÊúÉË©±: ${stats.active_sessions} | 
                    Áî¢ÂìÅÊï∏Èáè: ${stats.total_products} | 
                    ÊßΩ‰ΩçÊû∂Êßã: ${stats.slot_schema_count}
                `;
            }

            setLoadingState(loading) {
                const sendButton = document.getElementById('sendButton');
                const messageInput = document.getElementById('messageInput');

                if (loading) {
                    sendButton.innerHTML = '<div class="loading"></div>';
                    sendButton.disabled = true;
                    messageInput.disabled = true;
                } else {
                    sendButton.innerHTML = 'ÁôºÈÄÅ';
                    sendButton.disabled = false;
                    messageInput.disabled = false;
                }
            }

            showError(message) {
                const chatContainer = document.getElementById('chatContainer');
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.textContent = message;
                chatContainer.appendChild(errorDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        // ÂàùÂßãÂåñËÅäÂ§©
        let mgfdChat;
        document.addEventListener('DOMContentLoaded', () => {
            mgfdChat = new MGFDChat();
        });
    </script>
</body>
</html>



