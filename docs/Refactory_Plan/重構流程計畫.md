# 重構流程計畫

> 原則：先建立觀測與測試，再逐步替換內部實作，確保每一步都可回溯。以下按先後順序列出。

## 1. 建立保護網 (最小影響)
1. **盤點依賴與環境變數**：整理現行 `config.py` 對 Milvus、DuckDB 的設定來源，記錄預設值。
2. **撰寫 Smoke Tests**：為 `DuckDBQuery`、`MilvusQuery`（可 mock Milvus 連線）、`ContentSplitter`、`LLMInitializer.safe_completion` 建立最小單元測試。避免改動原始碼，只透過 fixture 模擬外部服務。
3. **導入結構化日誌接口**：新增共用 `utils/logger.py`（或沿用既有方案），先在測試環境驗證不改變現行輸出即可記錄 log。

## 2. 低風險內部優化
4. **DatabaseQuery 介面擴充**：加入 `__enter__/__exit__` 與自訂例外，並將 `DuckDBQuery`、`MilvusQuery` 以最小改動實作此介面。
5. **DuckDBQuery 連線延遲化**：改為 lazy connect + 自動重連，保留既有方法簽章；同時將 `print` 改為 logger。
6. **ContentSplitter Metadata 回填**：於分割的 `Document.metadata` 加入 `source`、`chunk_id` 等資訊，不影響既有回傳型別。

## 3. 專注於設定與擴充性 (中等影響)
7. **MilvusQuery 設定化**：將 host、port、collection 名稱與 `output_fields` 搬至 `config.py` 或 `.env`，並保留舊參數的向下相容行為。新增欄位驗證避免 runtime 錯誤。
8. **替換向量嵌入實作**：改用 `langchain_huggingface` 套件並加上 fallback 模式；同一步驟建立 rerank/filters 的函式接口，但暫不改動外部呼叫方式。
9. **LLMInitializer 健康檢查**：導入定期 ping Ollama 的方法與 fallback 模型設定，確保服務不中斷。

## 4. 功能強化與模組化 (較大影響)
10. **實作 DSPyLLMInitializer**：完成 DSPy 整合並提供對照測試，確保與現行初始化流程可互換。
11. **建置 RAGPipeline Orchestrator**：封裝「資料庫檢索 → LLM 生成」流程，先在新服務或旗標控制下試行，逐步取代既有散落呼叫。
12. **擴充輸出資料結構**：定義檢索結果 DTO（含欄位說明與信心分數），並更新單元測試。

## 5. 收斂與驗收
13. **整合測試與負載驗證**：針對主要業務路徑（Milvus 搜尋 + LLM 回應）撰寫整合測試；於 staging 進行負載測試並觀察 log。
14. **文件更新**：同步更新 `docs/` 下開發手冊、環境部署與使用範例；確保新 API 與舊稱呼差異有遷移指南。
15. **回顧與後續排程**：檢視是否需進一步資料治理（版本控制、熱更新），並排入下一輪迭代。
