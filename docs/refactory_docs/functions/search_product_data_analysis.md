# search_product_data 函式分析報告

## 函式運作解構

### 核心流程
`search_product_data(self, message: str) -> Dict[str, Any]` 是一個多階段產品規格搜尋函式，整合了智能產品代碼檢測、語義搜尋和資料庫查詢。

#### 步驟一：智能產品代碼檢測
- 使用 `_extract_product_codes()` 進行四重安全閘門檢測
- **Layer 1**: 字母+數字模式（如 APX819, AKK839）
- **Layer 2**: 純數字模式（如 819, 8329）
- **Layer 3**: 上下文關鍵詞驗證（系統、機型、筆電等）
- **Layer 4**: 資料庫存在性驗證

#### 步驟二：語義搜尋
- 透過 Milvus 向量搜尋取得相關產品
- 固定 `top_k=30` 結果
- 提取 `product_id` 並正規化為字串鍵

#### 步驟三：結果融合
- 將檢測到的產品代碼轉換為數字序列（modeltype）
- 檢測結果優先於語義搜尋結果
- 合併去重後形成最終的 `matched_keys`

#### 步驟四：DuckDB 規格查詢
- 使用 `matched_keys` 作為 `modeltype` 查詢 `nbtypes` 表
- 僅選取必要欄位以提升效能
- 回傳結構化的產品規格資料

## 可能的缺點

### 1. 偵測策略侷限
- **規則固定性**: 字母+數字與純數字模式較為固定，對異形型號（不同長度、混合符號、品牌前綴/後綴）敏感度有限
- **語言域偏向**: 上下文關鍵詞主要針對筆電情境，跨產業遷移時可能誤判或漏判
- **數字提取策略**: 只取第一段數字作為 modeltype，可能錯過複雜型號的關鍵資訊

### 2. 融合與排序問題
- **缺乏置信度融合**: 檢測結果直覺性前置，但缺少可解釋的排序或置信度融合機制
- **固定參數**: 語義搜尋 `top_k=30` 固定，未根據不同查詢類型自適應調整

### 3. 資料層耦合
- **硬編碼依賴**: DuckDB 表名和欄位硬編碼，跨產品域需要修改程式碼
- **鍵值對應假設**: 假設 Milvus 的 `product_id` 與資料表 `modeltype` 一一對應，若不同步會失配

### 4. 查詢安全與效能
- **SQL 注入風險**: 使用字串拼接 IN 子句，雖來自內部鍵但仍存在潛在風險
- **同步查詢**: 每次呼叫都建立新連線，高併發時可能出現 IO 競爭
- **無快取機制**: 重複查詢相同產品時無法利用快取

### 5. 回傳與使用者體驗
- **無分頁控制**: 缺少分頁或裁切策略控制回傳大小
- **缺乏來源分數**: 未提供各來源的分數供上游精排使用
- **錯誤訊息籠統**: 失敗時缺少詳細的可觀測性資訊

## 可能的改進方向

### 1. 模型與規則彈性化
- **外部化配置**: 將產品代碼抽取規則與上下文詞表外部化，支援多語系和不同品牌
- **豐富型號支援**: 支援更複雜的型號樣式（混合符號、變長、版號/世代標記）
- **輕量 NER**: 引入可選的命名實體識別模型提升檢測準確度

### 2. 檢索與融合優化
- **可配置參數**: 支援動態調整 `top_k` 和查詢擴展策略
- **分數融合框架**: 建立統一的打分框架，結合語義分數與代碼檢測置信度
- **重排序機制**: 提供多種排序策略（相關性、熱門度、價格等）

### 3. 資料抽象層
- **介面抽象**: 以介面抽象資料來源與結構，減少對特定資料表的硬耦合
- **欄位映射**: 增加欄位映射與單位/語系正規化層
- **多資料源支援**: 支援多個資料庫或索引的並行查詢與合併

### 4. 穩健性與效能
- **參數化查詢**: 使用參數化查詢或臨時表避免字串拼接
- **連線池**: 實作連線池和快取機制降低重複查詢成本
- **批處理**: 支援批量查詢以提升效能

### 5. 可觀測性增強
- **追蹤指標**: 增加查詢耗時、命中率、來源分佈等追蹤指標
- **詳細日誌**: 提供更詳細的執行過程和錯誤資訊
- **效能監控**: 實作效能監控和告警機制

## 可能的擴充方向

### 1. 多來源融合
- **並行查詢**: 支援多個資料庫或索引的並行查詢
- **結果合併**: 實作智能的結果合併策略
- **權重配置**: 支援不同來源的權重配置

### 2. 多語系與地區支援
- **語系適配**: 支援不同語系的上下文詞表和斷詞
- **地區差異**: 支援不同地區的型號差異
- **文化適應**: 考慮不同文化的產品命名習慣

### 3. 多鍵匹配
- **輔助鍵**: 支援 SKU、family、series、year 等輔助鍵的匹配
- **級聯匹配**: 實作多層級的匹配策略
- **消歧機制**: 處理多個候選結果的消歧

### 4. 使用場景擴展
- **對比功能**: 支援產品對比和替代品推薦
- **庫存查詢**: 整合庫存和價格資訊
- **相容性檢驗**: 支援配件與主機的相容性檢查

## 更一般化的應用考量

### 1. 抽象介面設計
- **檢索層抽象**: `semantic_search(query) -> List[{id, score, attrs}]`
- **抽取層抽象**: 可插拔的規則/模型介面
- **資料存取抽象**: 統一的資料存取介面

### 2. 結構化契約
- **產品實體模型**: 定義通用的產品實體模型
- **欄位對映表**: 標準化的欄位對映機制
- **融合策略配置**: 可配置的融合策略

### 3. 可運維性
- **設定集中化**: 透過配置檔案管理各種參數
- **監控告警**: 實作完整的監控和告警機制
- **版本管理**: 支援配置和模型的版本管理

## 結論

`search_product_data` 函式在筆電產品搜尋場景下表現良好，但存在多個可改進的空間。透過抽象化設計、彈性化配置和效能優化，可以將其擴展為更通用的產品搜尋解決方案，支援多種產品類型和應用場景。

關鍵改進方向包括：
1. 提升檢測策略的彈性和準確度
2. 實作更智能的結果融合機制
3. 建立可擴展的資料抽象層
4. 增強系統的可觀測性和穩健性
5. 支援多語系和多地區的產品搜尋需求
