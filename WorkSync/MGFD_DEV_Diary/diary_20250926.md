# 2025-09-26 開發日誌

## 問題一：Milvus 語義搜尋報錯 `'NoneType' object has no attribute 'search'`
- **現象**：查詢「請給我AC01的規格」時，後端日誌顯示 `Milvus 語義搜索失敗: 'NoneType' object has no attribute 'search'`。
- **原因**：`MilvusQuery.set_collection()` 找不到設定的集合，結果 `self.collection` 保持為 `None`，後續語義搜尋直接對空物件呼叫 `.search()`。
- **處理**：提示需確認連線到的 Milvus 實例與集合是否存在，並在 `milvus_semantic_search()` 中新增日誌輸出目前使用的 collection，以便快速定位設定問題。

## 問題二：初始化時提示集合不存在
- **現象**：系統啟動時輸出「錯誤: Collection 'semantic_nb_20250926_utf8_collection' 不存在。」
- **原因**：`milvusQuery` 連到的 Milvus alias 內查不到該集合；常見情境是主機/port 指向不同實例，或集合建立在非 `default` database。
- **處理**：建議在連線後列出 `utility.list_collections()` 驗證實際可見的集合，必要時調整 `connections.connect()` 的 host、port 或 `db_name` 設定，確保集合資訊一致。

## 問題三：語義銷售規格庫找不到
- **現象**：查詢 AC01 時，日誌顯示「語義銷售規格知識庫不存在」，回傳狀態 `no_database`。
- **原因**：`_initialize_default_knowledge_bases()` 仍硬編碼載入 `all_nbinfo_v3.db`，未同步到最新的 `all_nbinfo_v5.db`，導致對應的 DuckDB 路徑未被註冊。
- **處理**：將初始化邏輯改為使用 `config.DB_PATH` / `config.DUCKDB_FILE`，確保與最新資料庫檔案一致。

## 問題四：DuckDB 查詢報錯 Table `nbtypes` 不存在
- **現象**：語義查詢後進入 DuckDB 取規格時，拋出 `Catalog Error: Table with name nbtypes does not exist!`。
- **原因**：`knowledge_bases` 中 DuckDB 的 `path` 為相對路徑，程式在不同工作目錄啟動時會建立新的空資料庫，導致缺少 `nbtypes` 表。
- **處理**：改用 `Path(config.DB_PATH).resolve()` 等方式保存絕對路徑，確保連線到既有資料庫，不會意外產生空檔案。

## 問題五：使用「機種」關鍵字無法辨識純數字型號
- **現象**：提問「請問是否有8329機種的資料」時，系統回覆找不到該型號；改問「8329型號」則可取得正確規格。
- **原因**：`_extract_product_codes()` 在做純數字代碼判斷時的 `context_keywords` 少了「機種」，導致上下文檢查未通過而忽略 8329。
- **處理**：建議將「機種」等同義詞加入 `context_keywords`，或採更彈性的語意判斷，確保純數字型號不會被錯誤過濾。

