我將進入研究模式來分析 `sales_ai.js` 在系統中的角色和運作方式。讓我先仔細閱讀這個文件的內容來了解其功能和架構。

[1 tool called]

基於對 `sales_ai.js` 文件的深入分析，我現在可以詳細解釋這個文件在系統中的角色和運作方式。

## `sales_ai.js` 在系統中的角色與運作分析

### �� **核心功能定位**

`sales_ai.js` 是整個銷售 AI 系統的前端核心組件，負責處理用戶與 AI 銷售助手的互動介面。它實現了一個智能的筆電推薦系統，通過多種對話模式來分析用戶需求並提供專業建議。

### ��️ **系統架構組成**

#### 1. **Markdown 渲染引擎**

- **智能表格解析器**: 自定義的 `parseMarkdownTable()` 函數，作為 `marked.js` 的備用方案
- **GitHub Flavored Markdown 支援**: 配置 `marked.js` 以支援表格、列表等進階格式
- **降級處理機制**: 當標準解析器失敗時，自動切換到自定義解析器

#### 2. **多模式對話系統**

- **Funnel Conversation**: 需求類型分析漏斗，引導用戶選擇分析方向
- **MultiChat**: 智能問卷系統，通過結構化問題收集用戶偏好
- **傳統對話**: 支援自由文本輸入的 AI 對話

#### 3. **智能推薦引擎**

- **系列比較**: 自動生成筆電規格比較表格
- **用途導向推薦**: 根據用戶需求類型提供專業建議
- **結構化結果展示**: 支援多種數據格式的動態渲染

### 🔄 **運作流程機制**

#### **初始化階段**

```javascript
function initSalesAI() {
    // 配置 marked.js 支援
    configureMarkedJS();
    // 測試表格解析功能
    testMarkdownTableConversion();
    // 設置事件監聽器
    setupEventListeners();
}
```

#### **對話處理流程**

1. **用戶輸入捕獲**: 監聽輸入框和發送按鈕事件
2. **API 通信**: 與後端 `/api/sales/chat-stream` 建立流式連接
3. **流式響應處理**: 實時解析 Server-Sent Events (SSE) 數據
4. **智能內容渲染**: 根據響應類型選擇適當的渲染函數

#### **響應類型路由**

```javascript
function renderMessageContent(container, content) {
    // 根據 content.type 路由到不同的渲染函數
    switch(content.type) {
        case 'funnel_start': renderFunnelStart(); break;
        case 'multichat_start': renderMultiChatStart(); break;
        case 'series_comparison_result': renderSeriesComparisonResult(); break;
        // ... 其他類型
    }
}
```

### 🎨 **用戶體驗特色**

#### **智能問卷系統**

- **一次性問卷**: 所有問題同時顯示，提高填寫效率
- **實時驗證**: 動態檢查問題完成狀態，即時反饋
- **進度追蹤**: 視覺化顯示問卷完成進度

#### **漏斗式需求分析**

- **引導式選擇**: 通過選項按鈕引導用戶選擇需求類型
- **專業流程路由**: 根據選擇自動執行相應的分析流程
- **結果展示優化**: 支援表格、圖表等多種展示形式

#### **響應式介面**

- **流式更新**: 實時顯示 AI 思考過程和回應
- **錯誤處理**: 優雅的錯誤提示和降級處理
- **複製功能**: 一鍵複製 AI 回應內容

### 🔧 **技術實現特點**

#### **流式通信**

- 使用 `fetch()` API 的 `ReadableStream` 處理流式響應
- 支援 Server-Sent Events (SSE) 格式
- 實時更新聊天介面，提供流暢的對話體驗

#### **數據格式適配**

- 自動檢測和轉換多種表格數據格式
- 支援字典格式到標準表格格式的轉換
- 智能處理 Markdown 和 HTML 混合內容

#### **事件驅動架構**

- 模組化的事件處理器設計
- 支援動態 DOM 元素綁定
- 優雅的錯誤處理和狀態管理

### �� **與後端系統的整合**

#### **API 端點**

- `/api/sales/chat-stream`: 主要對話流接口
- `/api/sales/funnel-question`: 漏斗問題獲取
- `/api/sales/funnel-choice`: 漏斗選擇處理
- `/api/sales/multichat-all`: 問卷答案提交

#### **數據交換格式**

- 支援 JSON 格式的結構化數據
- 流式文本響應處理
- 錯誤狀態和成功狀態的統一處理

### �� **系統優勢與特色**

1. **多模式支援**: 靈活切換不同對話模式，適應不同用戶需求
2. **智能降級**: 當主要功能失敗時，自動切換到備用方案
3. **實時響應**: 流式通信提供即時的用戶反饋
4. **可擴展性**: 模組化設計便於添加新的對話類型和渲染邏輯
5. **用戶友好**: 直觀的介面設計和智能的交互流程

這個文件是整個銷售 AI 系統的前端核心，通過精心的設計實現了複雜的 AI 對話功能，為用戶提供了專業、智能的筆電推薦服務。
