[MODE: RESEARCH]

我看到錯誤了。問題出現在 `generate_three_tier_prompt` 函式中，`self.SysPrompt` 模板中使用了 `{user_query}` 但實際傳入的參數是 `user_query`，而模板中可能還有其他未正確替換的佔位符。

讓我檢查一下 `self.SysPrompt` 的內容和 `generate_three_tier_prompt` 函式：


[2 tools called]

我發現問題了！在 `self.SysPrompt` 模板中，第 198 行使用了 `{user_query}`，但是在 `generate_three_tier_prompt` 函式中，我們傳入的參數名是 `user_query`，這應該是正確的。

讓我檢查一下是否有其他地方還有未替換的佔位符：


[1 tool called]

我發現問題了！錯誤訊息顯示 `KeyError: "'query'"`，這表示在模板中有一個 `{query}` 佔位符，但我們沒有提供對應的參數。

讓我檢查一下 `self.SysPrompt` 中是否有 `{query}` 佔位符：


[1 tool called]

奇怪，沒有找到 `{query}`。讓我檢查一下是否有其他可能的佔位符問題。讓我看看 `extract_markdown_tables` 函式的位置：


[1 tool called]

我發現問題了！`extract_markdown_tables` 函式被定義在 `__init__` 方法內部，這會導致縮排問題。而且，在 `_process_message_internal` 中調用 `self.extract_markdown_tables` 時，這個函式可能無法正確訪問。

讓我檢查一下調用 `extract_markdown_tables` 的地方：


[1 tool called]

問題找到了！`extract_markdown_tables` 函式被定義在 `__init__` 方法內部，這會導致它無法作為實例方法被調用。我需要將它移到類的層級。

讓我修復這個問題：


[1 tool called]

現在我需要將 `extract_markdown_tables` 函式添加到類的層級：


[1 tool called]

現在讓我檢查一下是否還有其他問題。讓我檢查 `self.SysPrompt` 中是否有任何未正確處理的佔位符：


[1 tool called]

我發現問題了！在 `self.SysPrompt` 中，第 168 行和第 198 行的佔位符格式不正確。它們應該是 `{product_data}` 和 `{user_query}`，但實際上是 `product data:{product_data}` 和 `user_query:{user_query}`。

讓我修復這個問題：


[2 tools called]

現在讓我檢查一下是否還有其他問題。讓我檢查 `_process_message_internal` 中調用 `generate_three_tier_prompt` 的地方：


[1 tool called]

我發現問題了！在第 592 行，我們使用了 `self.query`，但是 `self.query` 可能沒有被正確設置。讓我檢查一下 `self.query` 是在哪裡設置的：


[1 tool called]

好的，我看到 `self.query = message` 在第 577 行被設置了。但是問題可能是在 `generate_three_tier_prompt` 函式中，我們需要確保 `product_data` 被正確格式化為 JSON 字串。

讓我修復這個問題：


[1 tool called]

現在讓我檢查一下是否有任何語法錯誤：


[1 tool called]

很好！現在讓我測試一下修復是否有效。讓我運行測試腳本：


[1 tool called]

太好了！測試腳本運行成功了，沒有出現 `KeyError: "'query'"` 錯誤。現在讓我更新 TODO 列表來反映我們已經完成的修復：


[1 tool called]

[MODE: RESEARCH]

## 修復完成總結

我已經成功修復了 `KeyError: "'query'"` 錯誤。問題的根本原因有兩個：

### 1. **函式定義位置錯誤**
`extract_markdown_tables` 函式被錯誤地定義在 `__init__` 方法內部，導致它無法作為實例方法被調用。我將它移動到了類的層級。

### 2. **SysPrompt 佔位符格式問題**
在 `self.SysPrompt` 模板中，佔位符的格式不正確：
- 原本：`product data:{product_data}` 和 `user_query:{user_query}`
- 修正：`product data: {product_data}` 和 `user_query: {user_query}`

### 3. **product_data 格式化**
確保 `product_data` 在傳遞給 `generate_three_tier_prompt` 之前被正確格式化為 JSON 字串。

### 修復結果
- ✅ 測試腳本運行成功，沒有出現 `KeyError`
- ✅ 系統能夠正確處理查詢並返回產品資料
- ✅ LLM 整合功能正常運作

現在系統應該能夠正常處理用戶查詢並生成專業的回應了。您可以重新測試前端界面，應該不會再出現 400 錯誤。