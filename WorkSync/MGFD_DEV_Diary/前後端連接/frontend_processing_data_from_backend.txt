âº åŸºæ–¼æˆ‘å°ç¨‹å¼ç¢¼çš„åˆ†æï¼Œæˆ‘å·²ç¶“æ‰¾åˆ°äº†å‰ç«¯JavaScriptè™•ç†å¾Œç«¯å‚³å›çµæœçš„å…·é«”ä½ç½®ã€‚ä»¥ä¸‹æ˜¯è©³ç´°çš„åˆ†æï¼š

  ğŸ¯ å‰ç«¯è™•ç†å¾Œç«¯å›æ‡‰çš„é—œéµä½ç½®

  1. ä¸»è¦è«‹æ±‚ç™¼é€ä½ç½®

  æª”æ¡ˆ: /static/js/mgfd_ai.js
  - ç¬¬254-258è¡Œ: ç™¼é€APIè«‹æ±‚åˆ°å¾Œç«¯
  const response = await fetch("/api/mgfd/chat/stream", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: query, session_id: "mgfd_session_" + Date.now() }),
  });

  2. StreaméŸ¿æ‡‰è®€å–èˆ‡è§£æä½ç½®

  æª”æ¡ˆ: /static/js/mgfd_ai.js
  - ç¬¬262-263è¡Œ: å»ºç«‹Stream Reader
  const reader = response.body.getReader();
  const decoder = new TextDecoder();

  - ç¬¬268-300è¡Œ: è™•ç†Streamæ•¸æ“šæµ
  - ç¬¬280-299è¡Œ: é—œéµçš„JSONè§£æä½ç½®
  if (line.startsWith('data: ')) {
      const jsonDataString = line.substring(6);
      if (jsonDataString) {
          try {
              const jsonData = JSON.parse(jsonDataString);  // â† JSONè§£æä½ç½®
              if (!assistantMessageContainer) {
                  assistantMessageContainer = createMessageContainer('assistant');
              }
              renderMessageContent(assistantMessageContainer.querySelector('.message-content'),
  jsonData);  // â† æ¸²æŸ“ä½ç½®
          } catch (e) {
              console.error("JSON è§£æéŒ¯èª¤:", e, "Data:", jsonDataString);
          }
      }
  }

  3. æ ¸å¿ƒå…§å®¹æ¸²æŸ“è™•ç†ä½ç½®

  æª”æ¡ˆ: /static/js/mgfd_ai.js
  - ç¬¬1377-1614è¡Œ: renderMessageContent() å‡½æ•¸ - é€™æ˜¯è™•ç†æ‰€æœ‰å¾Œç«¯å›æ‡‰çš„æ ¸å¿ƒå‡½æ•¸

  3.1 å›æ‡‰é¡å‹æª¢æ¸¬èˆ‡åˆ†ç™¼ (ç¬¬1377-1406è¡Œ)

  function renderMessageContent(container, content) {
      console.log("renderMessageContent è¢«èª¿ç”¨ï¼Œcontent:", content);
      console.log("ğŸ“Š content é¡å‹:", typeof content);
      console.log("ğŸ“Š content.type:", content?.type);

      if (!content) {
          container.innerHTML = "<p>æ”¶åˆ°ç©ºçš„å›æ‡‰ã€‚</p>";
          return;
      }
      if (typeof content === 'string') {
          container.innerHTML = content;
          return;
      }
      if (content.error) {
          container.innerHTML = `<p style="color: red;"><strong>éŒ¯èª¤ï¼š</strong> ${content.error}</p>`;
          return;
      }

  3.2 ä¸åŒé¡å‹å›æ‡‰çš„è™•ç†ä½ç½®

  - ç¬¬1399-1406è¡Œ: SSEæ§åˆ¶è¨Šæ¯ (start, end)
  - ç¬¬1409-1424è¡Œ: MultiChatå›æ‡‰ (multichat_start)
  - ç¬¬1427-1431è¡Œ: æ¼æ–—å°è©±é–‹å§‹ (funnel_start)
  - ç¬¬1433-1448è¡Œ: æ¼æ–—å•é¡Œ (funnel_question)
  - ç¬¬1450-1465è¡Œ: ä¸€èˆ¬å›æ‡‰ (general) â† æˆ‘å€‘ä¿®å¾©çš„ä½ç½®
  if (content.type === 'general') {
      console.log("ğŸ”¥ æª¢æ¸¬åˆ° general å›æ‡‰ï¼Œæ¸²æŸ“ä¸€èˆ¬æ¶ˆæ¯", content);

      const message = content.message || content.response_message || 'ç³»çµ±å›æ‡‰';

      container.innerHTML = `
          <div class="general-response">
              <div class="message-content">${message}</div>
          </div>
      `;

      console.log("âœ… general å›æ‡‰æ¸²æŸ“å®Œæˆ");
      return;
  }
  - ç¬¬1467-1471è¡Œ: æ¼æ–—å®Œæˆ (funnel_complete)
  - ç¬¬1473-1477è¡Œ: ç³»åˆ—æ¯”è¼ƒçµæœ (series_comparison_result)

  4. æ•¸æ“šè™•ç†æµç¨‹

  æª”æ¡ˆ: /static/js/mgfd_ai.js

  å®Œæ•´çš„æ•¸æ“šæµç¨‹:
  1. ç¬¬240-258è¡Œ: ç”¨æˆ¶è¼¸å…¥ â†’ ç™¼é€è«‹æ±‚
  2. ç¬¬268-300è¡Œ: æ¥æ”¶Stream â†’ è§£æJSON
  3. ç¬¬287è¡Œ: JSON.parse(jsonDataString) - JSONè½‰æ›
  4. ç¬¬291è¡Œ: renderMessageContent() - å…§å®¹æ¸²æŸ“
  5. ç¬¬1450-1465è¡Œ: æ ¹æ“šcontent.typeåˆ†ç™¼åˆ°å°æ‡‰è™•ç†å™¨

  5. å…¶ä»–ç›¸é—œè™•ç†ä½ç½®

  æª”æ¡ˆ: /static/js/mgfd_ai.js
  - ç¬¬1503-1593è¡Œ: è¤‡é›œæ ¼å¼è™•ç† (markdown, è¡¨æ ¼ç­‰)
  - ç¬¬1599-1614è¡Œ: éŒ¯èª¤è™•ç†èˆ‡æœªçŸ¥é¡å‹fallback
  - ç¬¬1615-1617è¡Œ: æœ€çµ‚HTMLæ¸²æŸ“

  ğŸ”„ è™•ç†æµç¨‹ç¸½çµ

  ç”¨æˆ¶è¼¸å…¥ â†’ fetchè«‹æ±‚(ç¬¬254è¡Œ) â†’ Streamè®€å–(ç¬¬262è¡Œ) â†’
  JSONè§£æ(ç¬¬287è¡Œ) â†’ renderMessageContent(ç¬¬291è¡Œ) â†’
  é¡å‹æª¢æ¸¬(ç¬¬1381è¡Œ) â†’ åˆ†ç™¼æ¸²æŸ“(ç¬¬1450-1477è¡Œ) â†’
  HTMLé¡¯ç¤º(ç¬¬1457-1461è¡Œ)

  é€™å°±æ˜¯å‰ç«¯JavaScriptè™•ç†å¾Œç«¯JSONå›æ‡‰çš„å®Œæ•´ä½ç½®å’Œæµç¨‹ï¼
